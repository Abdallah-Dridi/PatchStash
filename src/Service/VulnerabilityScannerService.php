<?php

namespace App\Service;

use App\Entity\Asset;
use App\Entity\Vulnerability;
use App\Repository\VulnerabilityRepository;
use Doctrine\ORM\EntityManagerInterface;
use Symfony\Contracts\HttpClient\HttpClientInterface;

final class VulnerabilityScannerService
{
    public function __construct(
        private HttpClientInterface $httpClient,
        private EntityManagerInterface $entityManager,
        private VulnerabilityRepository $vulnerabilityRepository,
    ) {
    }

    public function scanAll(): array
    {
        $assets = $this->entityManager->getRepository(Asset::class)->findAll();
        $results = [
            'assets_scanned' => 0,
            'vulnerabilities_found' => 0,
            'new_vulnerabilities' => 0,
            'errors' => [],
        ];

        foreach ($assets as $asset) {
            if (!$asset->getSoftwareName() || !$asset->getSoftwareVersion()) {
                continue;
            }

            $results['assets_scanned']++;
            try {
                $count = $this->scanAsset($asset);
                $results['new_vulnerabilities'] += $count;
            } catch (\Exception $e) {
                $results['errors'][] = sprintf('Error scanning asset %s: %s', $asset->getName(), $e->getMessage());
            }
        }

        return $results;
    }

    public function scanAsset(Asset $asset): int
    {
        $software = urlencode(trim(strtolower((string)$asset->getSoftwareName())));
        $version = trim((string)$asset->getSoftwareVersion());
        
        if (empty($software) || empty($version)) {
            return 0;
        }

        // Increase limit to 100 to find specific versions in broad product searches
        $url = sprintf('https://cve.circl.lu/api/vulnerability/?product=%s&limit=100', $software);
        error_log("Scanning URL: $url");
        
        $response = $this->httpClient->request('GET', $url, [
            'headers' => [
                'Accept' => 'application/json',
            ],
            'timeout' => 20,
        ]);
        
        if ($response->getStatusCode() !== 200) {
            throw new \Exception('Failed to fetch data from CVE API (Status: ' . $response->getStatusCode() . ')');
        }

        $content = $response->getContent();
        // Strip BOM if present
        if (str_starts_with($content, "\xEF\xBB\xBF")) {
            $content = substr($content, 3);
        }

        $data = json_decode($content, true);
        if ($data === null) {
            error_log("JSON Decode failed: " . json_last_error_msg());
            return 0;
        }

        // Handle single object vs array
        if (isset($data['dataType']) && !isset($data[0])) {
            $data = [$data];
        }

        error_log("Received " . count($data) . " items from API");

        $newCount = 0;

        foreach ($data as $item) {
            // Defensive check: ensure item is an array and has an ID or cveMetadata
            $cveId = null;
            if (isset($item['cveMetadata']['cveId'])) {
                $cveId = $item['cveMetadata']['cveId'];
            } elseif (isset($item['id'])) {
                $cveId = $item['id'];
            }

            if (!$cveId || !is_array($item)) {
                continue;
            }

            // Extract description from various possible locations
            $details = '';
            if (isset($item['details'])) $details = $item['details'];
            elseif (isset($item['containers']['cna']['descriptions'][0]['value'])) $details = $item['containers']['cna']['descriptions'][0]['value'];
            elseif (isset($item['summary'])) $details = $item['summary'];
            
            $detailsLower = strtolower($details);
            $isMatch = false;
            
            // 1. Check if version is in the summary/details
            if ($detailsLower !== '' && str_contains($detailsLower, strtolower($version))) {
                $isMatch = true;
            }

            // 2. Check structural 'affected' data
            if (!$isMatch && isset($item['containers']['cna']['affected'])) {
                foreach ($item['containers']['cna']['affected'] as $affected) {
                    if (isset($affected['versions'])) {
                        foreach ($affected['versions'] as $v) {
                            $vBase = $v['version'] ?? '';
                            $vStr = strtolower($vBase);
                            
                            if ($vStr !== 'n/a' && $vStr !== '' && (str_contains($vStr, strtolower($version)) || $vStr === strtolower($version))) {
                                $isMatch = true;
                            }
                            
                            if (!$isMatch && isset($v['lessThan']) && $this->isValidVersion($v['lessThan'])) {
                                if ($this->versionCompare($version, $v['lessThan'], '<')) {
                                    if ($vBase !== '0' && $vBase !== '' && $vBase !== 'n/a' && $this->isValidVersion($vBase)) {
                                        if ($this->versionCompare($version, $vBase, '>=')) $isMatch = true;
                                    } else {
                                        $isMatch = true;
                                    }
                                }
                            }

                            if (!$isMatch && isset($v['changes']) && is_array($v['changes'])) {
                                $currentStatus = ($v['status'] ?? '') === 'affected';
                                foreach ($v['changes'] as $change) {
                                    if (isset($change['at']) && $this->isValidVersion($change['at'])) {
                                        if ($this->versionCompare($version, $change['at'], '>=')) {
                                            $currentStatus = ($change['status'] ?? '') === 'affected';
                                        }
                                    }
                                }
                                if ($currentStatus) $isMatch = true;
                            }

                            if ($isMatch) break 2;
                        }
                    }
                }
            }

            // 3. Fallback: Regex range matching in description
            if (!$isMatch && $detailsLower !== '') {
                if (preg_match('/before\s+([0-9]+\.[0-9]+(\.[0-9]+)?)/i', $detailsLower, $matches)) {
                    if ($this->versionCompare($version, $matches[1], '<')) $isMatch = true;
                }
                if (!$isMatch && preg_match('/through\s+([0-9]+\.[0-9]+(\.[0-9]+)?)/i', $detailsLower, $matches)) {
                    if ($this->versionCompare($version, $matches[1], '<=')) $isMatch = true;
                }
            }

            if ($isMatch) {
                $cveId = null;
                if (isset($item['cveMetadata']['cveId'])) {
                    $cveId = $item['cveMetadata']['cveId'];
                } elseif (isset($item['id'])) {
                    $cveId = $item['id'];
                }

                $existing = $this->vulnerabilityRepository->findOneBy([
                    'cveId' => $cveId,
                    'asset' => $asset
                ]);

                if (!$existing) {
                    $vulnerability = new Vulnerability();
                    $vulnerability->setCveId($cveId);
                    $vulnerability->setName(sprintf('%s vulnerability for %s', $cveId, $asset->getSoftwareName()));
                    $vulnerability->setDescription($details ?: 'No description available.');
                    
                    // Extract CVSS from various possible locations
                    $cvss = 0.0;
                    $metrics = $item['metrics'] ?? [];
                    if (isset($metrics['cvssMetricV31'][0]['cvssData']['baseScore'])) {
                        $cvss = (float)$metrics['cvssMetricV31'][0]['cvssData']['baseScore'];
                    } elseif (isset($metrics['cvssMetricV30'][0]['cvssData']['baseScore'])) {
                        $cvss = (float)$metrics['cvssMetricV30'][0]['cvssData']['baseScore'];
                    } elseif (isset($metrics['cvssMetricV2'][0]['cvssData']['baseScore'])) {
                        $cvss = (float)$metrics['cvssMetricV2'][0]['cvssData']['baseScore'];
                    }
                    elseif (isset($item['containers']['cna']['metrics'][0]['cvssV3_1']['baseScore'])) {
                        $cvss = (float)$item['containers']['cna']['metrics'][0]['cvssV3_1']['baseScore'];
                    } elseif (isset($item['containers']['cna']['metrics'][0]['cvssV3_0']['baseScore'])) {
                        $cvss = (float)$item['containers']['cna']['metrics'][0]['cvssV3_0']['baseScore'];
                    }

                    $vulnerability->setSeverity($this->mapCvssToSeverity($cvss));
                    $vulnerability->setCvss($cvss);
                    $vulnerability->setAsset($asset);
                    
                    $this->entityManager->persist($vulnerability);
                    $newCount++;
                }
            }
        }

        $this->entityManager->flush();
        return $newCount;
    }

    private function versionCompare(string $v1, string $v2, string $operator): bool
    {
        // Simple version comparison helper
        return version_compare($v1, $v2, $operator);
    }

    private function isValidVersion(string $version): bool
    {
        // Simple check: version should usually start with a digit
        // and contain dots or numbers.
        return preg_match('/^[0-9]/', trim($version)) === 1;
    }

    private function mapCvssToSeverity(float $cvss): string
    {
        if ($cvss >= 9.0) return 'Critical';
        if ($cvss >= 7.0) return 'High';
        if ($cvss >= 4.0) return 'Medium';
        return 'Low';
    }
}
